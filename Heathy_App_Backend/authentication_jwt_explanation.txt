ğŸ” LOGIC ÄÄ‚NG KÃ, ÄÄ‚NG NHáº¬P VÃ€ JWT - GIáº¢I THÃCH CHI TIáº¾T
================================================================

ğŸ¯ Tá»”NG QUAN LUá»’NG AUTHENTICATION
================================

ğŸ“± Client App
    â†“ HTTP Request
ğŸŒ AuthController (API Endpoint)
    â†“ Business Logic  
ğŸ­ AuthService (Xá»­ lÃ½ logic)
    â†“ Database Operations
ğŸ—„ï¸ UserRepository (LÆ°u/láº¥y dá»¯ liá»‡u)
    â†“ JWT Operations
ğŸ” JwtUtils (Táº¡o/kiá»ƒm tra token)
    â†“ Response
ğŸ“± Client App (Nháº­n token)

1. ğŸ†• LOGIC ÄÄ‚NG KÃ (SIGNUP)
===========================

BÆ°á»›c 1: Client gá»­i request Ä‘Äƒng kÃ½
----------------------------------
POST /api/auth/signup
Content-Type: application/json

{
    "email": "user@example.com",
    "password": "123456",
    "fullName": "Nguyá»…n VÄƒn A"
}

BÆ°á»›c 2: AuthController nháº­n request
-----------------------------------
@PostMapping("/signup")
public ResponseEntity<MessageResponse> registerUser(@Valid @RequestBody SignupRequest signUpRequest) {
    // @Valid: Kiá»ƒm tra validation (email format, password length...)
    MessageResponse response = authService.registerUser(signUpRequest);
    
    if (response.getMessage().startsWith("Error:")) {
        return ResponseEntity.badRequest().body(response);  // HTTP 400
    }
    return ResponseEntity.ok(response);  // HTTP 200
}

BÆ°á»›c 3: AuthService xá»­ lÃ½ logic Ä‘Äƒng kÃ½
-------------------------------------
public MessageResponse registerUser(SignupRequest signUpRequest) {
    // 1. Kiá»ƒm tra email Ä‘Ã£ tá»“n táº¡i chÆ°a
    if (userRepository.existsByEmail(signUpRequest.getEmail())) {
        return new MessageResponse("Error: Email is already in use!");
    }
    
    // 2. Táº¡o User má»›i
    User user = new User();
    user.setEmail(signUpRequest.getEmail());
    user.setPasswordHash(passwordEncoder.encode(signUpRequest.getPassword())); // MÃ£ hÃ³a password
    user.setFullName(signUpRequest.getFullName());
    user.setProvider("local"); // ÄÃ¡nh dáº¥u Ä‘Äƒng kÃ½ local (khÃ´ng pháº£i OAuth)
    
    // 3. LÆ°u User vÃ o database
    userRepository.save(user);
    
    // 4. Tá»± Ä‘á»™ng táº¡o UserProfile vÃ  MenstrualCycle cho user má»›i
    createDefaultUserProfile(user);
    
    return new MessageResponse("User registered successfully!");
}

BÆ°á»›c 4: Táº¡o dá»¯ liá»‡u máº·c Ä‘á»‹nh
----------------------------
private void createDefaultUserProfile(User user) {
    // Táº¡o UserProfile trá»‘ng (user sáº½ cáº­p nháº­t sau)
    UserProfile profile = new UserProfile();
    profile.setUserId(user.getId());
    profile.setUser(user);
    userProfileRepository.save(profile);
    
    // Táº¡o MenstrualCycle trá»‘ng (user sáº½ cáº­p nháº­t sau)
    MenstrualCycle defaultCycle = new MenstrualCycle();
    defaultCycle.setUser(user);
    defaultCycle.setStartDate(null); // Sáº½ Ä‘Æ°á»£c set khi user cáº­p nháº­t
    defaultCycle.setEndDate(null);
    menstrualCycleRepository.save(defaultCycle);
}

2. ğŸ”‘ LOGIC ÄÄ‚NG NHáº¬P (SIGNIN)
=============================

BÆ°á»›c 1: Client gá»­i request Ä‘Äƒng nháº­p
-----------------------------------
POST /api/auth/signin
Content-Type: application/json

{
    "email": "user@example.com",
    "password": "123456"
}

BÆ°á»›c 2: AuthController nháº­n request
----------------------------------
@PostMapping("/signin")
public ResponseEntity<AuthResponse> authenticateUser(@Valid @RequestBody LoginRequest loginRequest) {
    AuthResponse authResponse = authService.authenticateUser(loginRequest);
    return ResponseEntity.ok(authResponse);
}

BÆ°á»›c 3: AuthService xá»­ lÃ½ Ä‘Äƒng nháº­p
----------------------------------
public AuthResponse authenticateUser(LoginRequest loginRequest) {
    // 1. Spring Security xÃ¡c thá»±c email/password
    Authentication authentication = authenticationManager.authenticate(
        new UsernamePasswordAuthenticationToken(loginRequest.getEmail(), loginRequest.getPassword())
    );
    
    // 2. LÆ°u authentication vÃ o SecurityContext
    SecurityContextHolder.getContext().setAuthentication(authentication);
    
    // 3. Táº¡o JWT token
    String jwt = jwtUtils.generateJwtToken(authentication);
    
    // 4. Láº¥y thÃ´ng tin user tá»« authentication
    UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal();
    
    // 5. Tráº£ vá» response vá»›i token vÃ  thÃ´ng tin user
    return new AuthResponse(jwt,
            userDetails.getId(),
            userDetails.getUsername(),
            userDetails.getFullName());
}

3. ğŸ« JWT TOKEN - CHI TIáº¾T
=========================

Cáº¥u hÃ¬nh JWT
------------
# application.properties
app.jwtSecret=AbCdEfGhIjKlMnOpQrStUvWxYz1234567890...
app.jwtExpirationMs=86400000  # 24 giá» = 24 * 60 * 60 * 1000 ms

Táº¡o JWT Token
-------------
public String generateJwtToken(Authentication authentication) {
    UserDetailsImpl userPrincipal = (UserDetailsImpl) authentication.getPrincipal();
    
    return Jwts.builder()
            .setSubject(userPrincipal.getUsername())  // Email cá»§a user
            .setIssuedAt(new Date())                  // Thá»i gian táº¡o
            .setExpiration(new Date((new Date()).getTime() + jwtExpirationMs))  // Thá»i gian háº¿t háº¡n
            .signWith(key(), SignatureAlgorithm.HS256)  // KÃ½ báº±ng secret key
            .compact();
}

Cáº¥u trÃºc JWT Token
-----------------
Header: {"alg": "HS256", "typ": "JWT"}
Payload: {"sub": "user@example.com", "iat": 1234567890, "exp": 1234654290}
Signature: HMACSHA256(base64UrlEncode(header) + "." + base64UrlEncode(payload), secret)

4. ğŸ›¡ï¸ JWT VALIDATION - KIá»‚M TRA TOKEN
====================================

AuthTokenFilter - Kiá»ƒm tra má»i request
-------------------------------------
@Override
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) {
    try {
        // 1. Láº¥y JWT token tá»« header "Authorization: Bearer <token>"
        String jwt = parseJwt(request);
        
        if (jwt != null && jwtUtils.validateJwtToken(jwt)) {
            // 2. Láº¥y email tá»« token
            String email = jwtUtils.getUserNameFromJwtToken(jwt);
            
            // 3. Load user details tá»« database
            UserDetails userDetails = userDetailsService.loadUserByUsername(email);
            
            // 4. Táº¡o authentication object
            UsernamePasswordAuthenticationToken authentication = 
                new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
            
            // 5. LÆ°u vÃ o SecurityContext (Ä‘Ã¡nh dáº¥u user Ä‘Ã£ Ä‘Äƒng nháº­p)
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
    } catch (Exception e) {
        logger.error("Cannot set user authentication: {}", e.getMessage());
    }
    
    // 6. Tiáº¿p tá»¥c xá»­ lÃ½ request
    filterChain.doFilter(request, response);
}

Láº¥y token tá»« request
-------------------
private String parseJwt(HttpServletRequest request) {
    String headerAuth = request.getHeader("Authorization");
    
    if (StringUtils.hasText(headerAuth) && headerAuth.startsWith("Bearer ")) {
        return headerAuth.substring(7);  // Bá» "Bearer " Ä‘i, chá»‰ láº¥y token
    }
    
    return null;
}

Validate JWT Token
-----------------
public boolean validateJwtToken(String authToken) {
    try {
        Jwts.parserBuilder().setSigningKey(key()).build().parse(authToken);
        return true;
    } catch (MalformedJwtException e) {
        logger.error("Invalid JWT token: {}", e.getMessage());
    } catch (ExpiredJwtException e) {
        logger.error("JWT token is expired: {}", e.getMessage());
    } catch (UnsupportedJwtException e) {
        logger.error("JWT token is unsupported: {}", e.getMessage());
    } catch (IllegalArgumentException e) {
        logger.error("JWT claims string is empty: {}", e.getMessage());
    }
    return false;
}

5. ğŸ” Cáº¤U HÃŒNH Báº¢O Máº¬T
=====================

WebSecurityConfig - Cáº¥u hÃ¬nh Spring Security
---------------------------------------------
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http.cors(withDefaults())  // Cho phÃ©p CORS
        .csrf(csrf -> csrf.disable())  // Táº¯t CSRF (vÃ¬ dÃ¹ng JWT)
        .exceptionHandling(exception -> exception.authenticationEntryPoint(unauthorizedHandler))
        .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))  // Stateless
        .authorizeHttpRequests(auth ->
            auth.requestMatchers("/api/auth/**").permitAll()  // Cho phÃ©p truy cáº­p auth endpoints
                .requestMatchers(HttpMethod.OPTIONS, "/**").permitAll()  // Cho phÃ©p OPTIONS requests
                .anyRequest().authenticated()  // CÃ¡c endpoint khÃ¡c cáº§n authentication
        );
    
    // ThÃªm JWT filter
    http.addFilterBefore(authenticationJwtTokenFilter(), UsernamePasswordAuthenticationFilter.class);
    return http.build();
}

PasswordEncoder - MÃ£ hÃ³a máº­t kháº©u
---------------------------------
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();  // Sá»­ dá»¥ng BCrypt Ä‘á»ƒ mÃ£ hÃ³a
}

// VÃ­ dá»¥ mÃ£ hÃ³a password:
String rawPassword = "123456";
String encodedPassword = passwordEncoder.encode(rawPassword);
// Káº¿t quáº£: "$2a$10$N9qo8uLOickgx2ZMRZoMye..."

6. ğŸ”„ LUá»’NG HOáº T Äá»˜NG HOÃ€N CHá»ˆNH
===============================

ÄÄƒng kÃ½:
--------
1. Client â†’ POST /api/auth/signup â†’ AuthController
2. AuthController â†’ AuthService.registerUser()
3. AuthService â†’ Kiá»ƒm tra email tá»“n táº¡i
4. AuthService â†’ MÃ£ hÃ³a password (BCrypt)
5. AuthService â†’ LÆ°u User vÃ o database
6. AuthService â†’ Táº¡o UserProfile + MenstrualCycle máº·c Ä‘á»‹nh
7. AuthService â†’ Tráº£ vá» "User registered successfully!"

ÄÄƒng nháº­p:
----------
1. Client â†’ POST /api/auth/signin â†’ AuthController
2. AuthController â†’ AuthService.authenticateUser()
3. AuthService â†’ AuthenticationManager.authenticate()
4. AuthenticationManager â†’ UserDetailsServiceImpl.loadUserByUsername()
5. UserDetailsServiceImpl â†’ UserRepository.findByEmail()
6. Spring Security â†’ So sÃ¡nh password (BCrypt)
7. AuthService â†’ JwtUtils.generateJwtToken()
8. AuthService â†’ Tráº£ vá» AuthResponse (token + user info)

Sá»­ dá»¥ng API vá»›i JWT:
-------------------
1. Client lÆ°u token tá»« response Ä‘Äƒng nháº­p
2. Client gá»­i request vá»›i header: "Authorization: Bearer <token>"
3. AuthTokenFilter â†’ Láº¥y token tá»« header
4. AuthTokenFilter â†’ JwtUtils.validateJwtToken()
5. AuthTokenFilter â†’ Láº¥y email tá»« token
6. AuthTokenFilter â†’ UserDetailsServiceImpl.loadUserByUsername()
7. AuthTokenFilter â†’ Táº¡o Authentication object
8. AuthTokenFilter â†’ LÆ°u vÃ o SecurityContext
9. Controller â†’ Xá»­ lÃ½ request (user Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c thá»±c)

7. ğŸ“ VÃ Dá»¤ Sá»¬ Dá»¤NG THá»°C Táº¾
==========================

ÄÄƒng kÃ½ user má»›i:
----------------
curl -X POST http://localhost:8080/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "123456",
    "fullName": "Test User"
  }'

# Response:
# {
#   "message": "User registered successfully!"
# }

ÄÄƒng nháº­p:
----------
curl -X POST http://localhost:8080/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "123456"
  }'

# Response:
# {
#   "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#   "id": 1,
#   "username": "test@example.com",
#   "fullName": "Test User"
# }

Sá»­ dá»¥ng API vá»›i JWT:
--------------------
# Láº¥y profile user (cáº§n JWT token)
curl -X GET http://localhost:8080/api/users/1/profile \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Response:
# {
#   "userId": 1,
#   "fullName": "Test User",
#   "email": "test@example.com",
#   "dateOfBirth": null,
#   "avatar": null,
#   "heightCm": null,
#   "weightKg": null,
#   "gender": null
# }

8. ğŸš¨ Xá»¬ LÃ Lá»–I
===============

Lá»—i Ä‘Äƒng kÃ½:
------------
// Email Ä‘Ã£ tá»“n táº¡i
if (userRepository.existsByEmail(signUpRequest.getEmail())) {
    return new MessageResponse("Error: Email is already in use!");
}

Lá»—i Ä‘Äƒng nháº­p:
---------------
// Spring Security tá»± Ä‘á»™ng throw exception náº¿u:
// - Email khÃ´ng tá»“n táº¡i
// - Password sai
// - User bá»‹ khÃ³a

Lá»—i JWT:
--------
// Token háº¿t háº¡n
catch (ExpiredJwtException e) {
    logger.error("JWT token is expired: {}", e.getMessage());
}

// Token khÃ´ng há»£p lá»‡
catch (MalformedJwtException e) {
    logger.error("Invalid JWT token: {}", e.getMessage());
}

ğŸ¯ TÃ“M Táº®T CHO INTERN
====================

ÄÄƒng kÃ½:
--------
1. Kiá»ƒm tra email Ä‘Ã£ tá»“n táº¡i chÆ°a
2. MÃ£ hÃ³a password báº±ng BCrypt
3. LÆ°u User vÃ o database
4. Táº¡o UserProfile + MenstrualCycle máº·c Ä‘á»‹nh
5. Tráº£ vá» thÃ´ng bÃ¡o thÃ nh cÃ´ng

ÄÄƒng nháº­p:
----------
1. Spring Security xÃ¡c thá»±c email/password
2. Táº¡o JWT token chá»©a thÃ´ng tin user
3. Tráº£ vá» token + thÃ´ng tin user

Sá»­ dá»¥ng API:
-----------
1. Client gá»­i token trong header Authorization: Bearer <token>
2. AuthTokenFilter kiá»ƒm tra token má»i request
3. Náº¿u token há»£p lá»‡ â†’ Cho phÃ©p truy cáº­p API
4. Náº¿u token khÃ´ng há»£p lá»‡ â†’ Tráº£ vá» lá»—i 401

JWT Token:
----------
- Chá»©a thÃ´ng tin user (email, thá»i gian táº¡o, háº¿t háº¡n)
- ÄÆ°á»£c kÃ½ báº±ng secret key
- CÃ³ thá»i háº¡n 24 giá»
- KhÃ´ng lÆ°u trÃªn server (stateless)

ÄÃ¢y lÃ  cÃ¡ch backend nÃ y báº£o máº­t vÃ  xÃ¡c thá»±c ngÆ°á»i dÃ¹ng má»™t cÃ¡ch an toÃ n! ğŸ”âœ¨

================================================================
Tá»‡p Ä‘Æ°á»£c táº¡o bá»Ÿi: AI Assistant
NgÃ y: 2024
Má»¥c Ä‘Ã­ch: Giáº£i thÃ­ch logic authentication vÃ  JWT cho developer intern
================================================================
